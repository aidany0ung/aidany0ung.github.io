<!DOCTYPE html>
<html>
<head>
  <style>
    #image-container {
      position: relative;
      display: inline-block;
      background-color: black;
    }

    #image-container img {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 1;
    }

    #color-picker-container {
      display: inline-block;
      vertical-align: top;
      margin-left: 20px;
    }
  </style>
</head>
<body>
  <div id="image-container">
    <img src="testgray.png" id="grayscale-image" />
  </div>

  <div id="color-picker-container">
    <label for="color-picker">Background Color:</label>
    <input type="color" id="color-picker">
  </div>

  <script>
    window.addEventListener('load', function() {
      var grayscaleImage = document.getElementById('grayscale-image');
      var colorPicker = document.getElementById('color-picker');

      // Load the grayscale image
      grayscaleImage.onload = function() {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');

        // Set the canvas dimensions
        canvas.width = grayscaleImage.width;
        canvas.height = grayscaleImage.height;

        // Draw the grayscale image on the canvas
        ctx.drawImage(grayscaleImage, 0, 0);

        // Get the image data from the canvas
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var pixels = imageData.data;

        // Function to update the background color
        function updateBackgroundColor() {
          var color = colorPicker.value;
          document.body.style.backgroundColor = color;
        }

        // Function to update the image opacity based on grayscale values
        function updateImageOpacity() {
          for (var i = 0; i < pixels.length; i += 4) {
            pixels[i] = 0;  // Set red channel to 0 (black)
            pixels[i + 1] = 0;  // Set green channel to 0 (black)
            pixels[i + 2] = 0;  // Set blue channel to 0 (black)

            var grayscaleValue = pixels[i];
            var opacity = 1 - grayscaleValue / 255;
            pixels[i + 3] = opacity * 255;
          }

          ctx.putImageData(imageData, 0, 0);
          grayscaleImage.src = canvas.toDataURL();
        }

        // Event listener for color picker change
        colorPicker.addEventListener('change', function() {
          updateBackgroundColor();
        });

        // Initial update of background color
        updateBackgroundColor();

        // Initial update of image opacity
        updateImageOpacity();
      };

      // Trigger the onload event to start processing the image
      grayscaleImage.src = grayscaleImage.src;
    });
  </script>
</body>
</html>
